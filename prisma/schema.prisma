// =======================================
// Prisma Generator & Datasource
// =======================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =======================================
// ENUMS
// =======================================

enum UserRole {
  ADMIN
  HOD
  FACULTY
  STUDENT
}

enum ProgramType {
  LEVEL
  DEGREE
}

enum AcademicLevel {
  UG
  PG
  DIPLOMA
  CERTIFICATE
}

enum CourseType {
  THEORY
  PRACTICAL
  BOTH
}

enum CourseCategory {
  MAD
  VAC
  SEC
  CORE
  VOCATIONAL
}

enum BloomLevel {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum AssessmentType {
  CONTINUOUS
  MID_TERM
  SEMESTER_END
  PRACTICAL
  OTHER
}

enum AssessmentMode {
  WRITTEN
  PRESENTATION
  ASSIGNMENT
  PROJECT
  LAB
  QUIZ
  MCQ
  VIVA
}

enum EnrollmentStatus {
  ENROLLED
  COMPLETED
  DROPPED
  FAILED
}

// =======================================
// USER
// =======================================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  role     UserRole

  departmentId String?
  department   Department? @relation("UserDepartment", fields: [departmentId], references: [id])

  hodDepartments Department[] @relation("HODRelation")

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdCourses Course[]
  createdClos    Clo[]
  
  faculty    Faculty?
  student    Student?
  
  enteredMarks Mark[] @relation("MarkEnterer")

  @@map("users")
}

// =======================================
// PROGRAM
// =======================================

model Program {
  id   String @id @default(cuid())
  name String
  code String?
  slug String @unique

  type  ProgramType
  level AcademicLevel?

  duration    Int?
  description String?

  parentId String?
  parent   Program?  @relation("ProgramHierarchy", fields: [parentId], references: [id])
  children Program[] @relation("ProgramHierarchy")

  departments Department[]
  pos         Po[]
  psos        Pso[]
  
  students    Student[]

  order     Int       @default(0)
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, parentId])
  @@index([parentId])
  @@map("programs")
}

// =======================================
// DEPARTMENT
// =======================================

model Department {
  id   String @id @default(cuid())
  name String
  code String?
  slug String @unique

  programId String
  program   Program @relation(fields: [programId], references: [id])

  hodId String?
  hod   User? @relation("HODRelation", fields: [hodId], references: [id])

  users     User[]     @relation("UserDepartment")
  courses   Course[]
  faculties Faculty[]
  students  Student[]

  description String?
  order       Int @default(0)

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, programId])
  @@index([programId])
  @@index([hodId])
  @@map("departments")
}

// =======================================
// COURSE
// =======================================

model Course {
  id   String @id @default(cuid())
  name String
  code String
  slug String @unique

  semester Int
  credits  Int?
  type     CourseType
  category CourseCategory?

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  createdById String
  createdBy   User @relation(fields: [createdById], references: [id])

  regulation  String?
  description String?

  clos        Clo[]
  assessments Assessment[]
  enrollments StudentCourseEnrollment[]
  facultyAssignments CourseFaculty[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, departmentId, semester])
  @@index([departmentId])
  @@index([semester])
  @@map("courses")
}

// =======================================
// CLO
// =======================================

model Clo {
  id        String @id @default(cuid())
  code      String
  statement String

  bloomLevel          BloomLevel
  attainmentThreshold Float @default(50.0)

  order Int @default(0)

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdById String
  createdBy   User @relation(fields: [createdById], references: [id])

  version String?

  poMappings  CloPoMapping[]
  psoMappings CloPsoMapping[]
  assessmentClos AssessmentClo[]
  marks       Mark[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, courseId])
  @@index([courseId])
  @@map("clos")
}

// =======================================
// PO
// =======================================

model Po {
  id        String @id @default(cuid())
  code      String
  statement String

  programId String
  program   Program @relation(fields: [programId], references: [id])

  order Int @default(0)

  mappings CloPoMapping[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, programId])
  @@index([programId])
  @@map("pos")
}

// =======================================
// PSO
// =======================================

model Pso {
  id        String @id @default(cuid())
  code      String
  statement String

  programId String
  program   Program @relation(fields: [programId], references: [id])

  order Int @default(0)

  mappings CloPsoMapping[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, programId])
  @@index([programId])
  @@map("psos")
}

// =======================================
// CLO → PO MAPPING
// =======================================

model CloPoMapping {
  id String @id @default(cuid())

  cloId String
  poId  String

  clo Clo @relation(fields: [cloId], references: [id])
  po  Po  @relation(fields: [poId], references: [id])

  level Int

  @@unique([cloId, poId])
  @@index([cloId])
  @@index([poId])
  @@map("clo_po_mappings")
}

// =======================================
// CLO → PSO MAPPING
// =======================================

model CloPsoMapping {
  id String @id @default(cuid())

  cloId String
  psoId String

  clo Clo @relation(fields: [cloId], references: [id])
  pso Pso @relation(fields: [psoId], references: [id])

  level Int

  @@unique([cloId, psoId])
  @@index([cloId])
  @@index([psoId])
  @@map("clo_pso_mappings")
}

// =======================================
// FACULTY
// =======================================

model Faculty {
  id              String  @id @default(cuid())
  name            String
  designation     String?
  qualifications  String?

  departmentId    String
  department      Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  userId          String?
  user            User?      @relation(fields: [userId], references: [id])

  courseAssignments CourseFaculty[]
  assessments     Assessment[]
    finalizedAssessments Assessment[] @relation("FinalizedAssessments")

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([departmentId])
  @@index([userId])
  @@map("faculties")
}

// =======================================
// COURSE-FACULTY ASSIGNMENT
// =======================================

model CourseFaculty {
  courseId            String
  facultyId           String
  semester            Int
  year                Int
  
  teachingMethodology String?
  assessmentMode      String?
  
  course              Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  faculty             Faculty @relation(fields: [facultyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([courseId, facultyId, semester, year])
  @@index([courseId])
  @@index([facultyId])
  @@index([semester])
  @@index([year])
  @@map("course_faculties")
}

// =======================================
// ASSESSMENT
// =======================================

model Assessment {
  id        String @id @default(cuid())
  
  courseId  String
  course    Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  facultyId String
  faculty   Faculty @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  
  semester  Int
  year      Int
  
  title       String
  description String?
  
  maxMarks  Float
  weightage Float @default(0)
  
  type      AssessmentType
  mode      AssessmentMode
  subType   String?
  
  scheduledDate     DateTime?
  submissionDeadline DateTime?
  
  isActive  Boolean   @default(true)
  
  // Marks finalization tracking
  isMarksFinalized Boolean @default(false)
  marksFinalizedAt DateTime?
  marksFinalizedById String?
  marksFinalizedBy Faculty? @relation("FinalizedAssessments", fields: [marksFinalizedById], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  assessmentClos AssessmentClo[]
  marks          Mark[]
  
  @@index([courseId])
  @@index([facultyId])
  @@index([semester])
  @@index([year])
  @@index([type])
  @@index([isMarksFinalized])
  @@map("assessments")
}
// =======================================
// ASSESSMENT CLO MAPPING
// =======================================

model AssessmentClo {
  assessmentId String
  cloId        String
  bloomLevel   BloomLevel
  weightage    Float @default(0)
  marksAllocated Float
  
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  clo        Clo       @relation(fields: [cloId], references: [id], onDelete: Cascade)
  
  @@id([assessmentId, cloId, bloomLevel])
  @@index([assessmentId])
  @@index([cloId])
  @@map("assessment_clos")
}

// =======================================
// STUDENT
// =======================================

model Student {
  id              String @id @default(cuid())
  rollNumber      String @unique
  admissionYear   Int
  currentSemester Int
  
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  userId String?@unique
  user   User?   @relation(fields: [userId], references: [id])
  
  enrollments StudentCourseEnrollment[]
  marks       Mark[]
  
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([departmentId])
  @@index([programId])
  @@index([userId])
  @@map("students")
}

// =======================================
// MARK
// =======================================

model Mark {
  studentId     String
  assessmentId  String
  cloId         String
  
  marksObtained Float @default(0)
  
  enteredById String
  enteredBy   User @relation("MarkEnterer", fields: [enteredById], references: [id], onDelete: Cascade)
  
  enteredAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  clo        Clo        @relation(fields: [cloId], references: [id], onDelete: Cascade)
  
  @@id([studentId, assessmentId, cloId])
  @@index([studentId])
  @@index([assessmentId])
  @@index([cloId])
  @@index([enteredById])
  @@map("marks")
}

// =======================================
// STUDENT COURSE ENROLLMENT
// =======================================

model StudentCourseEnrollment {
  studentId String
  courseId  String
  semester  Int
  year      Int
  
  status EnrollmentStatus @default(ENROLLED)
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@id([studentId, courseId, semester, year])
  @@index([studentId])
  @@index([courseId])
  @@index([semester])
  @@index([year])
  @@map("student_course_enrollments")
}